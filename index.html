<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REGISTRO DE PEDIDOS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: white;
            text-align: center;
            padding: 20px;
            text-transform: uppercase;
        }
        .opciones {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .registro-form, .registros {
            display: none;
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
            padding: 20px;
            border: 1px solid #555;
            background-color: #222;
        }
        .registro-form.active, .registros.active {
            display: block;
        }
        label, input, textarea, select, button {
            display: block;
            margin: 5px auto;
            width: 100%;
            color: white;
            background-color: #333;
            border: 1px solid #555;
            padding: 5px;
            text-align: center;
            border-radius: 12px;
        }
        button {
            cursor: pointer;
            margin-top: 10px;
            text-transform: uppercase;
            border-radius: 12px;
        }
        button:not(.cancelar):not(.borrar-filtro):not(.regresar) {
            background-color: #4CAF50;
        }
        button:hover:not(.cancelar):not(.borrar-filtro):not(.regresar) {
            background-color: #45a049;
        }
        .cancelar, .borrar-filtro, .regresar {
            background-color: #f44336;
        }
        .cancelar:hover, .borrar-filtro:hover, .regresar:hover {
            background-color: #e53935;
        }
        .message {
            color: #4CAF50;
            margin-top: 10px;
        }
        .registro.entrega {
            background-color: blue;
        }
        .registro.finalizado {
            background-color: green;
        }
        #reloj-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        #reloj {
            font-size: 20px;
        }
        #busquedaPedidoContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .alerta {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }
        .alerta.active {
            display: flex;
        }
        .alerta-content {
            background: #222;
            padding: 20px;
            border: 1px solid #555;
            text-align: center;
            border-radius: 12px;
        }
        .alerta button {
            background-color: #4CAF50;
            margin-top: 10px;
        }
        .alerta button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div id="reloj-container">
        <div id="reloj"></div>
    </div>
    <h1 id="tituloPrincipal">REGISTRO DE PEDIDOS</h1>

    <div id="opciones" class="opciones">
        <button onclick="mostrarFormulario('entrega')">SURTIDO</button>
        <button onclick="mostrarFormulario('finalizado')">EMPAQUE</button>
        <button onclick="mostrarTodosRegistros()">REGISTROS</button>
    </div>

    <div id="registroEntrega" class="registro-form">
        <h2>ENTREGA DE PEDIDOS A EMPAQUE</h2>
        <form id="formEntrega">
            <label for="nombreEntrega">SELECCIONE USUARIO:</label>
            <select id="nombreEntrega" required>
                <option value="">SELECCIONE UN USUARIO</option>
                <option value="ISAC">ISAC</option>
                <option value="RAFAEL">RAFAEL</option>
                <option value="ALEJANDRO">ALEJANDRO</option>
                <option value="CARLOS">CARLOS</option>
                <option value="ISRRAEL">ISRRAEL</option>
                <option value="ARTURO">ARTURO</option>
            </select>
            <label for="pedidoEntrega">GDL:</label>
            <input type="text" id="pedidoEntrega" required>
            <label for="fechaHoraImpresion">FECHA Y HORA DE IMPRESIÓN DE DOCUMENTO:</label>
            <input type="datetime-local" id="fechaHoraImpresion" required>
            <button type="button" onclick="registrar('entrega')">REGISTRAR ENTREGA</button>
            <button type="button" class="cancelar" onclick="cancelarRegistro()">CANCELAR</button>
        </form>
        <p id="mensajeEntrega" class="message"></p>
    </div>

    <div id="registroFinalizado" class="registro-form">
        <h2>REGISTRO DE EMPAQUE</h2>
        <form id="formFinalizado">
            <label for="nombreFinalizado">SELECCIONE USUARIO:</label>
            <select id="nombreFinalizado" required>
                <option value="">SELECCIONE UN USUARIO</option>
                <option value="EDGAR">EDGAR</option>
                <option value="MARCOS">MARCOS</option>
                <option value="IRVIN">IRVIN</option>
                <option value="KAREN">KAREN</option>
                <option value="FRANCISCO">FRANCISCO</option>
            </select>
            <label for="pedidoFinalizado">GDL:</label>
            <input type="text" id="pedidoFinalizado" required>
            <label for="fechaHoraInicioEmpaque">FECHA Y HORA DE INICIO DE EMPAQUE:</label>
            <input type="datetime-local" id="fechaHoraInicioEmpaque" required>
            <label for="estatus">ESTATUS:</label>
            <select id="estatus" required>
                <option value="COMPLETO">COMPLETO</option>
                <option value="INCIDENCIA">INCIDENCIA</option>
            </select>
            <textarea id="observaciones" placeholder="OBSERVACIONES (SI APLICA)"></textarea>
            <button type="button" onclick="registrar('finalizado')">FINALIZAR</button>
            <button type="button" class="cancelar" onclick="cancelarRegistro()">CANCELAR</button>
        </form>
        <p id="mensajeFinalizado" class="message"></p>
    </div>

    <div id="registros" class="registros">
        <h2>REGISTROS REALIZADOS</h2>
        <div id="busquedaPedidoContainer">
            <label for="pedidoBusqueda">BUSCAR POR PEDIDO (GDL):</label>
            <input type="text" id="pedidoBusqueda">
            <div>
                <button onclick="buscarPorPedido()">APLICAR FILTRO</button>
                <button class="borrar-filtro" onclick="borrarFiltro()">BORRAR FILTRO</button>
            </div>
            <button onclick="exportarRegistros()">EXPORTAR REGISTROS</button>
            <button class="regresar" onclick="volverAlPrincipal()">REGRESAR</button>
        </div>
        <div id="listaRegistros"></div>
    </div>

    <div id="alertaDuplicado" class="alerta">
        <div class="alerta-content">
            <p id="alertaMensaje"></p>
            <button onclick="cerrarAlerta()">ACEPTAR</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script>
        const formIds = {
            entrega: 'formEntrega',
            finalizado: 'formFinalizado'
        };

        function mostrarFormulario(opcion) {
            document.querySelectorAll('.registro-form').forEach(form => form.classList.remove('active'));
            document.getElementById('registros').classList.remove('active');
            document.getElementById('opciones').style.display = 'none';
            document.getElementById('tituloPrincipal').style.display = 'none';
            document.getElementById(`registro${capitalize(opcion)}`).classList.add('active');
        }

        function registrar(opcion) {
            const form = document.getElementById(formIds[opcion]);
            const nombre = form.querySelector('select[id^="nombre"]').value;
            const pedido = form.querySelector('input[id^="pedido"]').value;
            const fechaHora = form.querySelector('input[type="datetime-local"]').value;
            const timestamp = new Date();

            // Verificar si el pedido ya ha sido registrado
            if (verificarDuplicado(opcion, pedido)) {
                mostrarAlerta(opcion);
                return;
            }

            const registro = {
                nombre,
                pedido,
                fechaHora: formatDateTime(new Date(fechaHora)),
                fechaRegistro: formatDateTime(timestamp),
                tiempoTotal: calcularTiempoTotal(new Date(fechaHora), timestamp)
            };

            if (opcion === 'finalizado') {
                registro.estatus = document.getElementById('estatus').value;
                registro.observaciones = document.getElementById('observaciones').value;
            }

            let registros = JSON.parse(localStorage.getItem(opcion)) || [];
            registros.push(registro);
            localStorage.setItem(opcion, JSON.stringify(registros));

            form.reset();
            mostrarMensaje(opcion, 'El registro se realizó exitosamente.');
        }

        function verificarDuplicado(opcion, pedido) {
            let registros = JSON.parse(localStorage.getItem(opcion)) || [];
            return registros.some(registro => registro.pedido.toUpperCase() === pedido.toUpperCase());
        }

        function mostrarAlerta(opcion) {
            const mensaje = opcion === 'entrega'
                ? "ADVERTENCIA EL PEDIDO QUE ESTA INGRESANDO YA HA SIDO REGISTRADO CON ANTERIORIDAD, FAVOR DE VALIDAR QUE EL PEDIDO NO HAYA SIDO SURTIDO DOS VECES"
                : "ADVERTENCIA EL PEDIDO YA HA SIDO REGISTRADO CON ANTERIORIDAD, FAVOR DE VALIDAD NUEVAMENTE EL PEDIDO";
            document.getElementById('alertaMensaje').innerText = mensaje;
            document.getElementById('alertaDuplicado').classList.add('active');
        }

        function cerrarAlerta() {
            document.getElementById('alertaDuplicado').classList.remove('active');
        }

        function cancelarRegistro() {
            document.querySelectorAll('.registro-form').forEach(form => form.classList.remove('active'));
            document.getElementById('opciones').style.display = 'flex';
            document.getElementById('tituloPrincipal').style.display = 'block';
        }

        function mostrarTodosRegistros() {
            mostrarRegistros();
            document.getElementById('registros').classList.add('active');
            document.getElementById('opciones').style.display = 'none';
            document.getElementById('tituloPrincipal').style.display = 'none';
        }

        function mostrarRegistros() {
            const tipos = ['entrega', 'finalizado'];
            let listaHTML = '';

            tipos.forEach(tipo => {
                const registros = JSON.parse(localStorage.getItem(tipo)) || [];
                registros.forEach(registro => {
                    listaHTML += `<div class="registro ${tipo}">
                                    <p><strong>Nombre:</strong> ${registro.nombre}</p>
                                    <p><strong>GDL:</strong> ${registro.pedido}</p>
                                    <p><strong>Fecha y Hora:</strong> ${registro.fechaHora}</p>
                                    <p><strong>Fecha del Registro:</strong> ${registro.fechaRegistro}</p>
                                    <p><strong>Tiempo Total:</strong> ${registro.tiempoTotal}</p>`;
                    if (tipo === 'finalizado') {
                        listaHTML += `<p><strong>Estatus:</strong> ${registro.estatus}</p>
                                      <p><strong>Observaciones:</strong> ${registro.observaciones}</p>`;
                    }
                    listaHTML += `</div>`;
                });
            });

            document.getElementById('listaRegistros').innerHTML = listaHTML;
        }

        function buscarPorPedido() {
            const pedidoBusqueda = document.getElementById('pedidoBusqueda').value.trim().toUpperCase();
            if (!pedidoBusqueda) return;

            const tipos = ['entrega', 'finalizado'];
            let listaHTML = '';

            tipos.forEach(tipo => {
                const registros = (JSON.parse(localStorage.getItem(tipo)) || []).filter(registro => registro.pedido.toUpperCase().includes(pedidoBusqueda));
                registros.forEach(registro => {
                    listaHTML += `<div class="registro ${tipo}">
                                    <p><strong>Nombre:</strong> ${registro.nombre}</p>
                                    <p><strong>GDL:</strong> ${registro.pedido}</p>
                                    <p><strong>Fecha y Hora:</strong> ${registro.fechaHora}</p>
                                    <p><strong>Fecha del Registro:</strong> ${registro.fechaRegistro}</p>
                                    <p><strong>Tiempo Total:</strong> ${registro.tiempoTotal}</p>`;
                    if (tipo === 'finalizado') {
                        listaHTML += `<p><strong>Estatus:</strong> ${registro.estatus}</p>
                                      <p><strong>Observaciones:</strong> ${registro.observaciones}</p>`;
                    }
                    listaHTML += `</div>`;
                });
            });

            document.getElementById('listaRegistros').innerHTML = listaHTML;
        }

        function borrarFiltro() {
            document.getElementById('pedidoBusqueda').value = '';
            mostrarRegistros();
        }

        function calcularTiempoTotal(fechaInicio, fechaFin) {
            const diff = fechaFin - fechaInicio;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours} horas y ${minutes} minutos`;
        }

        function formatDateTime(date) {
            return new Intl.DateTimeFormat('es-ES', {
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: true 
            }).format(date);
        }

        function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function exportarRegistros() {
    const tipos = ['entrega', 'finalizado'];
    let wb = XLSX.utils.book_new();
    const registrosEmpaque = JSON.parse(localStorage.getItem('empaque')) || [];
    const registrosSurtido = JSON.parse(localStorage.getItem('surtido')) || [];
    const fechaImpresion = new Date();
    const fechaImpresionISO = fechaImpresion.toISOString();

    tipos.forEach(tipo => {
        const registros = JSON.parse(localStorage.getItem(tipo)) || [];
        const data = registros.map(registro => {
            const [hours, minutes] = registro.tiempoTotal.match(/\d+/g); // Extraer horas y minutos del tiempo total
            const commonData = {
                Nombre: registro.nombre,
                GDL: registro.pedido,
                'Fecha y Hora': registro.fechaHora,
                'Fecha del Registro': registro.fechaRegistro,
                'Horas': hours,
                'Minutos': minutes
            };
            return tipo === 'finalizado' ? { ...commonData, Estatus: registro.estatus, Observaciones: registro.observaciones } : commonData;
        });
        const ws = XLSX.utils.json_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, `Registros de ${capitalize(tipo)}`);
    });

    // Crear la nueva hoja con la información adicional
    let nuevaHojaData = [['GDL', 'Fecha de Impresión', 'Fecha de Registro de Empaque', 'Usuario de Surtido', 'Usuario de Empaque', 'Tiempo Total']];
    
    registrosSurtido.forEach(surtido => {
        const registroEmpaque = registrosEmpaque.find(empaque => empaque.pedido === surtido.pedido);
        if (registroEmpaque) {
            const tiempoTotal = (fechaImpresion - new Date(registroEmpaque.fechaRegistro)) / (1000 * 60 * 60); // tiempo total en horas
            nuevaHojaData.push([
                surtido.pedido,
                fechaImpresionISO,
                registroEmpaque.fechaRegistro,
                surtido.usuario,
                registroEmpaque.usuario,
                tiempoTotal.toFixed(2) // Redondear a 2 decimales
            ]);
        }
    });
    
    const nuevaHoja = XLSX.utils.aoa_to_sheet(nuevaHojaData);
    XLSX.utils.book_append_sheet(wb, nuevaHoja, 'Resumen GDL');
    
    // Formatear la fecha para usar en el nombre del archivo
    const fechaArchivo = fechaImpresion.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).replace(/\//g, '-');
    
    const nombreArchivo = `REPORTE_${fechaArchivo}.xlsx`;
    XLSX.writeFile(wb, nombreArchivo);
}
        function volverAlPrincipal() {
            document.getElementById('registros').classList.remove('active');
            document.getElementById('listaRegistros').innerHTML = '';
            document.getElementById('opciones').style.display = 'flex';
            document.getElementById('tituloPrincipal').style.display = 'block';
        }

        function actualizarReloj() {
            const now = new Date();
            const horas = now.getHours() % 12 || 12;
            const minutos = String(now.getMinutes()).padStart(2, '0');
            const segundos = String(now.getSeconds()).padStart(2, '0');
            const ampm = now.getHours() >= 12 ? 'PM' : 'AM';
            document.getElementById('reloj').innerText = `${horas}:${minutos}:${segundos} ${ampm}`;
        }

        function mostrarMensaje(opcion, mensaje) {
            document.getElementById(`mensaje${capitalize(opcion)}`).innerText = mensaje;
            setTimeout(() => {
                document.getElementById(`mensaje${capitalize(opcion)}`).innerText = '';
                cancelarRegistro();
            }, 3000);
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        window.onload = function() {
            setInterval(actualizarReloj, 1000);
        };
    </script>
</body>
</html>