<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REGISTRO DE PEDIDOS</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <div id="reloj-container">
        <div id="reloj"></div>
    </div>
    <h1 id="tituloPrincipal">REGISTRO DE PEDIDOS</h1>

    <div id="opciones" class="opciones">
        <button onclick="mostrarFormulario('entrega')">SURTIDO</button>
        <button onclick="mostrarFormulario('finalizado')">EMPAQUE</button>
        <button onclick="mostrarTodosRegistros()">REGISTROS</button>
    </div>

    <div id="registroEntrega" class="registro-form">
        <h2>ENTREGA DE PEDIDOS A EMPAQUE</h2>
        <form id="formEntrega">
            <label for="nombreEntrega">SELECCIONE USUARIO:</label>
            <select id="nombreEntrega" required>
                <option value="">SELECCIONE UN USUARIO</option>
                <option value="ISAC">ISAC</option>
                <option value="RAFAEL">RAFAEL</option>
                <option value="ALEJANDRO">ALEJANDRO</option>
                <option value="CARLOS">CARLOS</option>
                <option value="ISRRAEL">ISRRAEL</option>
                <option value="ARTURO">ARTURO</option>
            </select>
            <label for="pedidoEntrega">GDL:</label>
            <input type="text" id="pedidoEntrega" required>
            <label for="fechaHoraImpresion">FECHA Y HORA DE IMPRESIÓN DE DOCUMENTO:</label>
            <input type="datetime-local" id="fechaHoraImpresion" required>
            <button type="button" onclick="registrar('entrega')">REGISTRAR ENTREGA</button>
            <button type="button" class="cancelar" onclick="cancelarRegistro()">CANCELAR</button>
        </form>
        <p id="mensajeEntrega" class="message"></p>
    </div>

    <div id="registroFinalizado" class="registro-form">
        <h2>REGISTRO DE EMPAQUE</h2>
        <form id="formFinalizado">
            <label for="nombreFinalizado">SELECCIONE USUARIO:</label>
            <select id="nombreFinalizado" required>
                <option value="">SELECCIONE UN USUARIO</option>
                <option value="EDGAR">EDGAR</option>
                <option value="MARCOS">MARCOS</option>
                <option value="IRVIN">IRVIN</option>
                <option value="KAREN">KAREN</option>
                <option value="FRANCISCO">FRANCISCO</option>
            </select>
            <label for="pedidoFinalizado">GDL:</label>
            <input type="text" id="pedidoFinalizado" required>
            <label for="fechaHoraInicioEmpaque">FECHA Y HORA DE INICIO DE EMPAQUE:</label>
            <input type="datetime-local" id="fechaHoraInicioEmpaque" required>
            <label for="estatus">ESTATUS:</label>
            <select id="estatus" required>
                <option value="COMPLETO">COMPLETO</option>
                <option value="INCIDENCIA">INCIDENCIA</option>
            </select>
            <textarea id="observaciones" placeholder="OBSERVACIONES (SI APLICA)"></textarea>
            <button type="button" onclick="registrar('finalizado')">FINALIZAR</button>
            <button type="button" class="cancelar" onclick="cancelarRegistro()">CANCELAR</button>
        </form>
        <p id="mensajeFinalizado" class="message"></p>
    </div>

    <div id="registros" class="registros">
        <h2>REGISTROS REALIZADOS</h2>
        <div id="busquedaPedidoContainer">
            <label for="pedidoBusqueda">BUSCAR POR PEDIDO (GDL):</label>
            <input type="text" id="pedidoBusqueda">
            <div>
                <button onclick="buscarPorPedido()">APLICAR FILTRO</button>
                <button class="borrar-filtro" onclick="borrarFiltro()">BORRAR FILTRO</button>
            </div>
            <button onclick="exportarRegistros()">EXPORTAR REGISTROS</button>
            <button class="regresar" onclick="volverAlPrincipal()">REGRESAR</button>
        </div>
        <div id="listaRegistros"></div>
    </div>

    <div id="alertaDuplicado" class="alerta">
        <div class="alerta-content">
            <p id="alertaMensaje"></p>
            <button onclick="cerrarAlerta()">ACEPTAR</button>
        </div>
    </div>
    <script src="script.js"></script>
    <script>
        function exportarRegistros() {
            const entregaRegistros = JSON.parse(localStorage.getItem('entrega')) || [];
            const finalizadoRegistros = JSON.parse(localStorage.getItem('finalizado')) || [];
        
            const wb = XLSX.utils.book_new();
        
            // Crear hoja para registros de entrega
            const entregaData = entregaRegistros.map(registro => [
                registro.pedido,
                registro.nombre,
                registro.fechaHora,
                registro.fechaRegistro,
                Math.floor(registro.tiempoTotal.split(' ')[0]), // horas
                Math.floor(registro.tiempoTotal.split(' ')[3])  // minutos
            ]);
            entregaData.unshift(['GDL', 'Usuario', 'Fecha de Impresión de Documento', 'Fecha del Registro', 'Horas Transcurridas', 'Minutos Transcurridos']);
            const entregaWS = XLSX.utils.aoa_to_sheet(entregaData);
            XLSX.utils.book_append_sheet(wb, entregaWS, 'Registros de Entrega');
        
            // Crear hoja para registros de finalizado
            const finalizadoData = finalizadoRegistros.map(registro => [
                registro.pedido,
                registro.nombre,
                registro.fechaHora,
                registro.fechaRegistro,
                Math.floor(registro.tiempoTotal.split(' ')[0]), // horas
                Math.floor(registro.tiempoTotal.split(' ')[3]), // minutos
                registro.estatus, // agregar campo estatus
                registro.observaciones // agregar campo observaciones
            ]);
            finalizadoData.unshift(['GDL', 'Usuario', 'Fecha y Hora de Inicio de Empaque', 'Fecha del Registro', 'Horas Transcurridas', 'Minutos Transcurridos', 'Estatus', 'Observaciones']);
            const finalizadoWS = XLSX.utils.aoa_to_sheet(finalizadoData);
            XLSX.utils.book_append_sheet(wb, finalizadoWS, 'Registros Finalizados');
        
            // Fecha actual para el nombre del archivo
            const fechaActual = formatDate(new Date());
            const nombreArchivo = `Registros_${fechaActual}.xlsx`;
        
            XLSX.writeFile(wb, nombreArchivo);
        }
        
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${year}${month}${day}`;
        }
    </script>
</body>
</html>